# MQ Questions

1. 如何保证幂等、顺序、不丢失


> Kafka 顺序性：<br />
  Kafka中并不能保证所有分区无状态消息的顺序性，但是可以保证一个分区中所有消息都是有顺序的，同时一个分区只会有一个消费者，所以可以利用这两个特性达到生产与消费的顺序一致性。比如用户的某些行为消息，我们要保证其前后顺序依次送达后端，那可以讲这些消息推送到一个分区；那如果要多个分区来保持高吞吐怎么办，这个时候就可以利用一些带状态的字段，比如用户id作为Kafka Msg的Key，Kafka的Broker会将这些声明了Key的消息按统一的规则散列到不同的分区，同一个Key只要散列规则没有变就会一直分发到同一个分区，所以只要生产者保证投送消息的顺序性，那消费端就能收到一样顺序的消息。


2. Kafka与rocketMQ集群原理、对比

3. MQ最终一致性，分布式事务问题

4. Kafka Key与Partition的关系。
> 答：消息在发送前会组装成K/V结构，消息通过其中的Partition或Key来确认Partition，当没有显式指名分区时，便会通过计算Key的Hash来分区。但是如果没有Key，也没有Partition，那就会先通过topic查询本地分区表（每隔*topic.metadata.refresh.interval.ms*刷新一次）找出分区，如果分区不存在，则会随机算出分区。


5. Kafka扩容后如何保证老数据仍然在老分区

